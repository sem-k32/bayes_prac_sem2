# Сегментация

## з)-и)

Сегментация для изображения - присвоение каждому пикелю класса, соответствующего определённому типу интересующего нас объекта (человек, машина, небо и т.д). В вероятностном смылсе задачу можно выразить как поиск наиболее правдоподнобной классификации пикселей на $ K $ классов в рамках вероятностной графической модели, аналогичной модели из коллажей. В данном случае стоит перенастроить одиночные и парные потенциалы.

Далее будет решаться задача сегментации для нескольких фото из [Flood Challenge](https://www.kaggle.com/datasets/faizalkarim/flood-area-segmentation?select=Image). Сначала попробуем классифицировать воду/не воду на фото (на базе Graph Cut, $ K = 2 $), далее попробуем выбирать воду/зелень/всё остальное (на базе $\alpha$-расширения, $ K = 3 $).

### Бинарная сегментация

Для унарных потенциалов сделаем следующее: возьмём небольшую область изображения с водой и посчитаем средний пиксель. Далее унарный потенциал будет пропорционален норме разности текущего пикселя и среднего воды (вода будет классом 0):

$$
    \Theta_i(x_i) \propto \begin{cases}
                                \lVert \text{pix}(x_i) - \text{pix}_{water} \rVert, \ x_i = 0 \\
                                1 - \lVert \text{pix}(x_i) - \text{pix}_{water} \rVert, \ x_i = 1
                          \end{cases}
$$

Можно было бы ввести более аккуратную модель для вероятности пикселя быть водой, например, на основе логистической регрессии, и обучить её на части размеченных фото. Но даже с глупым нормированием данного унарного потенциала получалось хорошо.

Двойные потенциалы были основаны на тех же моделях, что и для коллажа: модель Поттса и учёт различности пикселей. Только теперь мы хотим проводить границу там, где пиксели будут сильно отличаться друг от друга (в этом месте происходит смена классов), поэтому теперь энергия должна убывать при увеличении различности пикселей:

$$
    \Theta_{ij}(x_i. x_j) = \exp(-\lambda \cdot \lVert \text{pix}(x_i) - \text{pix}(x_j) \rVert) [x_i \not= x_j]
$$

или

$$
    \Theta_{ij}(x_i. x_j) = (-\beta \cdot \lVert \text{pix}(x_i) - \text{pix}(x_j) \rVert)^{\lambda} [x_i \not= x_j]
$$

Данные потенциалы также нормировались в $ [0, 1] $ с помощью параметров шкалирования для согласованностью с масштабом $ \Theta_i(x_i) $.

Реализация алгоритмов - в ```src/graph_cut```. Результаты c данными потенциалами приведены в ```experiments/graph_cut```: маска сегментации, изображение с наложенной маской и значение точности сегментации алгоритма относительно ручного выделения. Значение accuracy получилось $ 75-85\% $. Полиномиальные потенциалы выдавали несколько меньшее качество.

### Сегментация на три класса

В качестве бинарных потенциалов взяты аналогичные $ \alpha $-расширению для коллажа - модель Поттса и норма разности пикселей для выполнения неравенства треугольника. 

Для унарных потенциалов снова были посчитаны средние пиксели воды и зелени из малых подобластей, после чего потенциалы были пропорцианальны различности текующего пикселя и среднего пикселя класса (как у бинарной классификации).

Реализация алгоритмов - в ```src/alpha_expansion```. Результаты c данными потенциалами приведены в ```experiments/alpha_expansion```: последовательность масок сегменатции после каждой итерации $ \alpha $-расширения и исходное фото с наложенной финальной маской. Результаты получились правдоподобными, но accuracy по классам не посчитать, т.к. ручная сегментация выделяла только воду.
