# Построение коллажа из двух изображений

## а)

Сделанные фото находятся в ``` data/ ```. Мы будем работать с фото 1 и 2.

## б)-в)

Система соседства: для данного пикселя берём пиксели слева, справа, снизу, сверху (на краях изображения некоторые варинаты будут отпадать). Брать больше соседей не принципиально, хотя возможно вплоть до всех пискелей в данной прямоугольной окрестности. Это усложнит граф и увеличит время поиска разреза.

Т.к. у нас нет для фотографий коллажа никаких индивидуальных априорных предположений, т.е. предпочтений насчёт какое фото "более важное", то одиночные потенциалы взяты за константу $ = 0 $. Но не все, т.к. необходимо определить какие-то начальные участки двух фотографий, которые обязательно должны быть включены в коллаж. Для этого делаем в нужных пикселях одиночный потенциал другой фотографии бесконечно большим:

$$
    \Theta_i(x_i) = \infty, \ x_i \in \{0, 1\}
$$

Т.к. мы минимизируем суммарную энергию, то в данном пискеле всегда будет выбрано нужное фото. Если не задать начальные участки для коллажа, то, скорей всего, минимизация $E$ приведёт к элементарному коллажу-копии одного из фото. Чтобы этого не произошло, парные потенциалы не должны везде поощрять равнество соседних пискелей больше, чем их различие, а нам хотелось бы сохранить это.

Для работы GraphCut необходимо выполнение условия субмодулярности парных потенциалов. Далее, имея начальные приближения коллажа в виде унарных потенциалов, у нас уже имеется некая граница двух классов. После заполнения классами оставшимися пикселями граница классов останется. Т.о. парный потенциал должен давать наименьший штраф перехода классов в той части изображений, где они изображения наиболее похожи. В этом случае граница классов будет незаметной, а коллаж правдоподобным для человека. Вне границы классов, соседние пиксели должны приходить из одного фото, поэтому нам пригодится модель Поттса.

Похожесть пикселей выражется $ \rho = \lVert \text{pix}(x_i) - \text{pix}(x_j) \rVert $ их нормой разности в RGB представлении, соответственно для потенциала достаточно взять любую возрастающую от этой метрики. В работе были выбраны $ f(\rho) = \exp(\lambda \rho) $ и $ f(\rho) = \rho^{\alpha} $. Итоговый потенциал:

$$
    \Theta_{ij}(x_i, x_j) = f(\lVert \text{pix}(x_i) - \text{pix}(x_j) \rVert) \cdot [x_i \not= x_j] 
$$

Условия субмодулярности, очевидно, выполняются, т.к. $ \Theta_{ij}(0, 0) = \Theta_{ij}(1, 1) = 0 $ и $ \Theta_{ij}(1, 0), \Theta_{ij}(0, 1) \ge 0 $

Минимизация энергии эквивалентна максимизации правдоподобия итогового коллажа, т.к.

$$
    E(\mathbf{x}) = - \log p(\mathbf{x})
$$

## г)

``` src/ ``` содержит базовый класс для GraphCut с реализацией самого алгортима, на выходе которого - коллаж и маска коллажа. Также там содержатся его производные с определением системы соседства и парных потенциалов.

В качестве алгортима поиска минимального разреза использовалась *networkx.algorithms.mincut*, который подозревается в некорректной работе на картинках большого размера. Поэтому размеры фото сжимались.

Все папки с резльтатами работы Graph Cut содержат итоговый коллаж и маску коллажа для большей наглядности.

В ```experiments/experiment_poly/``` содержатся результаты для полиномиального парного потенциала разной настройки степени полинома. Фото сжимались в 2 раза. Результаты сильно разнились: где-то одно из изображений не появлялось вообще; где же были два изображения, то начальные приближения одного из фото не сильно расширялись и поэтому обрезались. Лучший результат [здесь](experiments/experiment_poly/results_alpha_1.10).

В ```experiments/experiment_exp/``` применялся экспоненциальный парный потенциал с гиперпараметром масштаба (не менялся в экспериментах). Здесь проводились разные сжатия изображения. Лучше всего алгортим отработал на картинках умеренного сжатия, резульат [здесь](experiments/experiment_exp/results_medium_reduce_1), немного обрезана только пробка бутылки. Для других сильно сжатых фото результат аналогичный, но изображения слишком маленькие, детали теряются. Для фото с малым сжатием граница проводилась слишком резко.

Также в экспериментах были опробованы различные варианты нормы $ \lVert \cdot \rVert_{p} $ для разности пикселей, на итоговое пострение границы изображений это не имело значительного эффекта.
